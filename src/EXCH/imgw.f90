!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! Information about last revision of $RCSfile: rhl.f90,v $:
! $Revision: 1.4 $
! $Author: hebhop $
! $Date: 2010/02/23 23:52:06 $
!
! v1 - Mixed weights, lost track of origin
! v2 - Using local training weights - scipy 1.7.1
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE imgw_v1(rs, xk, temp, eim)
  ! temperature in unit of hartree
  ! xk in unit of a.u.
  ! eim in unit of hatree
  USE constants
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, xk, temp
  REAL(8), INTENT(OUT) :: eim

  INTEGER :: mrs
  REAL(8), DIMENSION(:) :: rsleft(24), tright(6), rsright(6), scaling(4)
  REAL(8), DIMENSION(27) :: left1, left2, left3, left4, p
  REAL(8), DIMENSION(36) :: right1, right2, right3, right4, qq
  REAL(8) :: vleft, vright, weight, k_boundary, t, k, rkf, ef, eim_kf
  ! REAL(8), PARAMETER :: fa = 1.9191582926775128d0, pi = 3.1415926535897932384626433832795d0

  DATA scaling / 0.012163698621989414d0, 0.06690755186151459d0, 0.35402213905982843d0, 0.6540650734032093d0 /
  DATA left1 / -0.09730116611517951d0, 0.019811787581018432d0, -0.9107593983619665d0, &
                0.04429457958312912d0, -0.002829886983994427d0, 0.4679177248651782d0, &
                -0.12920151858760917d0, -0.3185960944710708d0, -0.6853260400838367d0, &
                0.05864888772460627d0, 0.19062026200270787d0, 0.3320705055412537d0, &
                0.22569358685714208d0, 0.24878999466001417d0, 1.6620823965743552d0, &
                -0.10285278556823735d0, -0.1581723331764946d0, -0.838851955728067d0, &
                0.021481438539048946d0, 0.18375504201186213d0, 0.2646365593837374d0, &
                0.028118057019198332d0, 0.3878911095790498d0, 0.12429020135523595d0, &
                -0.04923156950114449d0, -0.5504701432426441d0, -0.4160785576258503d0 /

  DATA right1 / -1.1281702352664078d0, 15.913917121155512d0, -15.781763286731191d0, &
                -8.196227222731984d0, 49.57397322108513d0, -54.859186787268406d0, &
                7.148275167140558d0, -37.08415785218802d0, 41.63729110321263d0, &
                -12.218014372748724d0, 59.87283626607546d0, -67.71261977276231d0, &
                -17.246302998638555d0, 82.30740207451787d0, -94.09633980972686d0, &
                2.1606534565867697d0, 5.411632668505843d0, -12.179092411480768d0, &
                17.994004196294703d0, 9.123347236345582d0, 8.606772473958118d0, &
                -58.47312852780925d0, 1.0625113379641786d0, -48.71757053540676d0, &
                -355.91252983782226d0, 190.63518944485625d0, -310.49378130241234d0, &
                214.80355604369302d0, -131.7421202745962d0, 118.66215483704421d0, &
                -429.60939281012014d0, 286.4172905542458d0, -315.45204472938093d0, &
                -1.4907763646708778d0, 8.076166718277117d0, -1.614001151428006d0 /
  
  DATA left2 / -0.1601209222500568d0, -1.1689316143699513d0, 1.0558126886303d0, &
                0.11309902121772979d0, 0.5849459844670819d0, -0.5726049588912363d0, &
                -0.36416056624418897d0, -0.86890695165242d0, 0.8088218974342717d0, &
                0.23222343055157713d0, 0.38696774972725145d0, -0.41242408747826753d0, &
                0.5499117076571199d0, 1.8790287734597042d0, -1.730582839999667d0, &
                -0.36043076429733906d0, -0.8785085669745413d0, 0.9058703916880849d0, &
                -0.014018914957450708d0, 0.6041754397450181d0, -0.3781817796528243d0, &
                0.015415318386368074d0, 0.7431802071380266d0, -0.47248889385247694d0, &
                0.002648081567479078d0, -1.3461391390947097d0, 0.8485070219155748d0 /
  DATA right2 / 1.2124314405967718d0, 4.362653904918381d0, 0.0644870840259468d0, &
                -6.052826011729766d0, -14.582800518248705d0, -3.0475157298312276d0, &
                4.891627448962329d0, 15.535535274868563d0, 8.71073073332997d0, &
                1.6916902132193923d0, 6.129100021914905d0, 12.986683851023564d0, &
                -4.795324539850384d0, 9.780199586281656d0, -68.77445618921504d0, &
                2.1223240396942145d0, -0.9853858615672741d0, 0.07285272264221357d0, &
                3.040897422460228d0, -1.624057453264639d0, 1.2388597307831737d0, &
                3.0808972467314835d0, -3.2825285078006523d0, 1.8322531925879286d0, &
                7.538853613459758d0, -10.689962213288286d0, 4.685103645264265d0, &
                -3.149847495870372d0, 5.846712789516093d0, -2.6993422306528916d0, &
                -16.785211916080595d0, 26.283869943955267d0, -11.124802704730993d0, &
                -0.25041311445387615d0, 2.9450940007931896d0, -0.28594019092691975d0 /
  DATA left3 / -0.4888688812237603d0, 0.28539850046718035d0, -0.08273287486482286d0, &
                0.2656325902645167d0, -0.1849691784345592d0, 0.052504778245743705d0, &
                -0.7222924620244626d0, 0.3576236963517782d0, -0.07483691492465128d0, &
                0.3952865822390625d0, -0.22927563599528483d0, 0.0494082188549157d0, &
                1.2045675641067852d0, -0.6302953954558612d0, 0.1535481192430782d0, &
                -0.6593883225209146d0, 0.4092545459441451d0, -0.10005795779991933d0, &
                0.2187487514974954d0, -0.003790727935850534d0, 0.00153321067844436d0, &
                0.3222868901764764d0, -0.03137964574105422d0, 0.0009654443979920085d0, &
                -0.5338036685775893d0, 0.03076617000441788d0, -0.002236088599183545d0 /
  DATA right3 / -2.4652385454861045d0, 2.2709369946116476d0, -0.016335383516986d0, &
                6.407346282173194d0, -3.5241610699720565d0, -0.938052150275685d0, &
                -5.330201111232691d0, 0.2097150467245504d0, 2.3913144246314464d0, &
                -2.759643208969734d0, -4.6749207208828905d0, 4.846048477877578d0, &
                1.274936238844436d0, -8.99534035230194d0, 6.344175089142765d0, &
                1.5942536840899906d0, -0.7080734263680196d0, 0.06020037998104392d0, &
                1.9858949542281634d0, -0.2126674702243764d0, 0.4372020277869658d0, &
                3.0259804599009854d0, -0.1865921940484292d0, 1.2872381342191748d0, &
                6.2597474728625455d0, -0.6447257049655256d0, 5.661178863033677d0, &
                0.9511711716444875d0, -5.071556705823834d0, 11.077219657751685d0, &
                -5.235149214896328d0, 2.958138301791755d0, -11.085413113349038d0, &
                0.6646470406851569d0, 0.40897370602960853d0, 0.18063699128754584d0 /

  DATA left4 / -0.2784040622721631d0, -0.015923208658958306d0, 0.010936406080942379d0, &
                0.15177687739002343d0, -0.013671299652304182d0, -0.001955551467937442d0, &
                -0.6602235069910223d0, 0.22243064479560798d0, -0.026186885954275728d0, &
                0.3507468887735972d0, -0.14026926391698746d0, 0.018100444392833998d0, &
                0.9916213260703696d0, -0.2500523604133429d0, 0.024459854621137585d0, &
                -0.5327649552961942d0, 0.17914527978686218d0, -0.02142230136888505d0, &
                0.2837717099371378d0, -0.04225811704879709d0, 0.006162296703193555d0, &
                0.3957333770673754d0, -0.08131130660031956d0, 0.009023081733350145d0, &
                -0.6749994220174723d0, 0.12072704401870088d0, -0.015089642050132496d0 /
  DATA right4 / -6.000006016596565d0, -0.5674645360422231d0, -0.08194210870224415d0, &
                -20.09957970932959d0, -7.6736716302976475d0, -0.9082009774103044d0, &
                -9.721151171770373d0, -10.391407207511312d0, -3.7162057539502245d0, &
                -3.375549352685843d0, 1.6362545698898001d0, -3.2904412671133585d0, &
                7.399267039799666d0, -8.563505107372434d0, 4.015324424866241d0, &
                -1.0294921526228644d0, 1.1312226646636925d0, -0.05235612645649135d0, &
                -0.1766141100011096d0, -0.11009354980440053d0, -0.12319707443052594d0, &
                0.008069772186224945d0, 0.1689695741639606d0, 0.15614385532021963d0, &
                0.272368412409354d0, -0.5726722195398571d0, -0.5296986853892816d0, &
                -4.436330713599893d0, 3.7741343244695202d0, 6.344404987856783d0, &
                -2.2339091003314797d0, 3.2818227500365795d0, 3.7788440868255257d0, &
                0.2676830746051518d0, -0.10237475806456857d0, -0.020508952084653007d0 /
  
  !------------------------------------------------------------
  ! Preprocessing
  !------------------------------------------------------------
  rkf = fa/rs
  ef = (rkf**2.d0)/2.d0
  k = xk / rkf
  t = temp / ef

  !------------------------------------------------------------
  ! Check for interpolation or extrapolation
  !------------------------------------------------------------
  IF (t.GT.2.d0) THEN
    PRINT*, "ERROR: Local electronic temperature is higher interpolation grid (T >= 2 TF)."
    PRINT*, "T = ", t, temp
    PRINT*, "rs = ", rs
    CALL par_stop
  ENDIF

  IF (rs.GT.20.d0) THEN
    PRINT*, "ERROR: rs > 20"
    CALL par_stop
  ENDIF

  IF (rs.LT.1.d-2) THEN
    PRINT*, "ERROR: rs < 0.01"
    CALL par_stop
  ENDIF

  ! Set to fermi level if below fermi level
  IF (k.LT.1.00001d0) THEN
      k = 1.00001d0
  ENDIF

  ! Determine which region of rs to use
  IF (rs.LT.0.2) THEN
      p = left1
      qq = right1
      mrs = 1
  ELSEIF (rs.LT.1.0) THEN
      p = left2
      qq = right2
      mrs = 2
  ELSEIF (rs.LT.5.0) THEN
      p = left3
      qq = right3
      mrs = 3
  ELSE
      p = left4
      qq = right4
      mrs = 4
  ENDIF
  
  !--------------------
  ! Imaginary part
  !--------------------
  CALL im_cusp_v1(rs, t, k_boundary)
  CALL im_kf_v1(rs, t, eim_kf)

  ! Left hand side
  rsleft(1) = p(1) * rs  + p(2)*rs**(3.d0/2.d0)  +  p(3)*rs**2.d0
  rsleft(2) = p(4) * rs  + p(5)*rs**(3.d0/2.d0)  +  p(6)*rs**2.d0
  rsleft(3) = p(7) * rs  + p(8)*rs**(3.d0/2.d0)  +  p(9)*rs**2.d0
  rsleft(4) = p(10) * rs + p(11)*rs**(3.d0/2.d0) +  p(12)*rs**2.d0
  rsleft(5) = p(13) * rs + p(14)*rs**(3.d0/2.d0) +  p(15)*rs**2.d0
  rsleft(6) = p(16) * rs + p(17)*rs**(3.d0/2.d0) +  p(18)*rs**2.d0
  rsleft(7) = p(19) * rs + p(20)*rs**(3.d0/2.d0) +  p(21)*rs**2.d0
  rsleft(8) = p(22) * rs + p(23)*rs**(3.d0/2.d0) +  p(24)*rs**2.d0
  rsleft(9) = p(25) * rs + p(26)*rs**(3.d0/2.d0) +  p(27)*rs**2.d0

  vleft = rsleft(1)*k*t &
        + rsleft(2)*k*(t**1.5d0) &
        + rsleft(3)*(k**2.d0)*t &
        + rsleft(4)*(k**2.d0)*(t**1.5d0) &
        + rsleft(5)*(k**1.5d0)*t &
        + rsleft(6)*(k**1.5d0)*(t**1.5d0) &
        + rsleft(7)*k & 
        + rsleft(8)*(k**2.d0) &
        + rsleft(9)*(k**1.5d0) &
        + eim_kf
  IF (vleft.LT.0.d0) THEN
    vleft = 0.d0
  ENDIF
  ! print*, rsleft(1), rsleft(2), rsleft(3), rsleft(4), rsleft(5), rsleft(6)
  ! print*, rsleft(7), rsleft(8), rsleft(9)


  ![-0.46372935] [0.20346769] [0.39460677] [-0.68524943] [0.32048492] [0.51356274]
  ![1.15491929] [-0.52727977] [-0.90495454]

  
  ! Right hand side
  rsright(1) = qq(1) * rs  + qq(2)*rs**(3.d0/2.d0)  +  qq(3)*rs**2.d0
  rsright(2) = qq(4) * rs  + qq(5)*rs**(3.d0/2.d0)  +  qq(6)*rs**2.d0
  rsright(3) = qq(7) * rs  + qq(8)*rs**(3.d0/2.d0)  +  qq(9)*rs**2.d0
  rsright(4) = qq(10) * rs  + qq(11)*rs**(3.d0/2.d0)  +  qq(12)*rs**2.d0
  rsright(5) = qq(13) * rs  + qq(14)*rs**(3.d0/2.d0)  +  qq(15)*rs**2.d0
  rsright(6) = qq(16) * rs  + qq(17)*rs**(3.d0/2.d0)  +  qq(18)*rs**2.d0

  tright(1) = qq(19) + qq(20)*t +  qq(21)*t**2.d0
  tright(2) = qq(22) + qq(23)*t +  qq(24)*t**2.d0
  tright(3) = qq(25) + qq(26)*t +  qq(27)*t**2.d0
  tright(5) = qq(28) + qq(29)*t +  qq(30)*t**2.d0
  tright(4) = qq(31) + qq(32)*t +  qq(33)*t**2.d0
  tright(6) = qq(34) + qq(35)*t +  qq(36)*t**2.d0
  ! print*, tright(1), tright(2), tright(3), tright(4), tright(5), tright(6)
  ! print*, rsright(1), rsright(2), rsright(3), rsright(4), rsright(5), rsright(6)

  ! [1.99086217] [3.03543934]  [6.25979544]  [-5.23141634] [0.9495449]  [0.66449063] tright
  ! [1.03885912] [-0.11115822] [-1.25343129] [-0.43254481] [1.26940609] [1.36394528] rsright
  ! [3.30936812] [7.80174861] [27.61501152] [-43.66052506] [35.11693639] [2.20514242]
  ! [1.04151751] [-0.11174835] [-1.25312891] [-0.43187571] [1.26780354] [1.36359809]

  vright = rsright(1)*tright(1)/k         &
         + rsright(2)*tright(2)/(k**2.d0) &
         + rsright(3)*tright(3)/(k**3.d0) &
         + rsright(4)*tright(4)/(k**4.d0) &
         + rsright(5)*tright(5)/(k**5.d0) &
         + rsright(6)*tright(6)/(k**0.5d0)
  IF (vright.LT.0.d0) THEN
    vright = 0.d0
  ENDIF
  ! Interpolate between regions
  weight = 1.d0/(1.d0 + EXP(10.d0*(k - 1.1d0*k_boundary)))
  eim = weight*vleft + (1.d0-weight)*vright*scaling(mrs)

  ! print*, "Reduced temperature = ", t, " rs = ", rs
  ! Scale back
  eim = -eim * ef
  RETURN
END SUBROUTINE imgw_v1

SUBROUTINE im_kf_v1(rs, t, kf)
  ! Imaginary part of quasiparticle self-energy at fermi level
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, t
  REAL(8), INTENT(OUT) :: kf
  REAL(8), DIMENSION(9) :: factors1, factors2, factors3, factors4, factors
  REAL(8) :: A, B, C
  INTEGER :: mrs
  DATA factors1 / -0.09094323574018673d0, 1.089160117026636d0, -0.7292298662705564d0, &
                  0.006462381104206332d0, -0.019802206542834953d0, 0.01113010261742388d0, &
                  0.04903214800885628d0, -0.6506372471873646d0, 0.5274238755315628d0 /
  DATA factors2 / 0.4316369508779085d0, -0.17245974727080232d0, 0.009809795774884911d0, &
                  3.5768469939869205d-5, -0.004287037992540818d0, 0.0020415490627589093d0, &
                  -0.47317800570803087d0, 0.610089125206505d0, -0.211092319733901d0 /
  DATA factors3 / -0.009515617697671723d0, 0.09982092613155993d0, 0.07964035978307292d0, &
                  -0.030979381407273337d0, 0.41236562921436426d0, -0.33077114773922256d0, &
                  0.00322951237168846d0, -0.03565817188719173d0, 0.004253783508400203d0 /
  DATA factors4 / -0.2759688536430732d0, 0.7430961585847626d0, -0.297181644446135d0, &
                  0.26653826932442615d0, -0.30590572296821034d0, 0.08998256117324012d0, &
                  0.04277863363447566d0, -0.13113824718924794d0, 0.0601847393212351d0 /
 
  ! 00 -> 1
  ! 01 -> 2
  ! 10 -> 3
  ! 11 -> 4
  mrs = 1
  IF (rs.LE.0.2d0) THEN
    mrs = mrs + 0
  ELSE
    mrs = mrs + 2
  ENDIF

  IF (t.LE.0.5d0) THEN
    mrs = mrs + 0
  ELSE
    mrs = mrs + 1
  ENDIF

  ! Shift from 0-index to 1-index
  SELECT CASE (mrs)
    CASE (1)
      factors = factors1
    CASE (2)
      factors = factors2
    CASE (3)
      factors = factors3
    CASE (4)
      factors = factors4
  END SELECT

  A = factors(1)*t + factors(2)*t**1.5d0 + factors(3)*t**2.d0
  B = factors(4)*t + factors(5)*t**1.5d0 + factors(6)*t**2.d0
  C = factors(7)*t + factors(8)*t**1.5d0 + factors(9)*t**2.d0
  kf = A*rs + B*rs**0.5d0 + C*rs**1.5d0
  RETURN
END SUBROUTINE im_kf_v1

SUBROUTINE im_cusp_v1(rs, t, k)
  ! Position of minimum for imaginary quasiparticle self-energy
  !
  ! Inputs:
  !   rs - radius
  !   t  - temperature in unit of fermi
  ! Output:
  !   k  - temperature in unit of fermi
  !
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, t
  REAL(8), INTENT(OUT) :: k
  REAL(8), PARAMETER :: alpha = 1.1495192084389452d0
  REAL(8), PARAMETER :: beta = 0.033376683130363946d0
  REAL(8), DIMENSION(6) :: factors
  REAL(8) :: A, B
  DATA factors / 0.1450147977529337d0, 0.233244548502498d0, -0.017661811059191113d0, &
                 1.3723845833398063d0, -0.05395611403472079d0, -0.02022335357291743d0 /

  A = factors(1) + factors(2)*t + factors(3)*t**2.d0
  B = factors(4) + factors(5)*t + factors(6)*t**2.d0
  k = (1.d0 + TANH((rs - 0.5d0)/alpha))*(beta*rs + A) + B

  RETURN
END SUBROUTINE im_cusp_v1

SUBROUTINE imgw_v2(rs, xk, temp, eim)
  ! temperature in unit of hartree
  ! xk in unit of a.u.
  ! eim in unit of hatree
  ! USE constants
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, xk, temp
  REAL(8), INTENT(OUT) :: eim

  INTEGER :: mrs
  REAL(8), DIMENSION(:) :: rsleft(24), tright(6), rsright(6), scaling(4)
  REAL(8), DIMENSION(27) :: left1, left2, left3, left4, p
  REAL(8), DIMENSION(36) :: right1, right2, right3, right4, qq
  REAL(8) :: vleft, vright, weight, k_boundary, t, k, rkf, ef, eim_kf
  REAL(8), PARAMETER :: fa = 1.9191582926775128d0, pi = 3.1415926535897932384626433832795d0

  DATA scaling / 0.011358051321446327, 0.0637710259641874, 0.3458217538503771, 0.6459817122849331 /
  DATA left1 / -0.3996084877917776d0, 1.5619375484723628d0, -2.8394175870705833d0, &
                0.23209925292414174d0, -0.9654187419185194d0, 1.6712478624220377d0, &
                -0.4874561959141273d0, 1.5037256449081757d0, -2.9596237738238536d0, &
                0.2809690251217274d0, -0.9428606121254859d0, 1.7436729543186533d0, &
                0.8875815885158318d0, -3.122410046101803d0, 5.873364460085901d0, &
                -0.5136592905099191d0, 1.9416086553623595d0, -3.4584841020954467d0, &
                0.10522063267277822d0, -0.23502107642632086d0, 0.7931114188357979d0, &
                0.12741075179508662d0, -0.11312575631205433d0, 0.7600031082923175d0, &
                -0.232860065381581d0, 0.3717152558382517d0, -1.582843856594346d0 /

  DATA right1 / -1.051699097983817d0, 15.7605480356678d0, -15.233090644952417d0, &
                3.578781012760475d0, -21.73202416174778d0, 23.81498829488864d0, &
                -7.88089609855281d0, 40.88236714341268d0, -45.525707747104185d0, &
                -30.002393040691693d0, 146.7394852005877d0, -164.67171231292798d0, &
                -15.605129680157468d0, 74.23528764158678d0, -84.30470772187726d0, &
                2.062510163377484d0, 6.089922176277204d0, -13.268159816006849d0, &
                17.321743110637776d0, 10.192118590735618d0, 8.7641751541308d0, &
                128.82200744826002d0, 4.464680955918343d0, 112.21833288947664d0, &
                313.0137985207077d0, -156.72890989858854d0, 277.7869396298057d0, &
                -168.9585087316882d0, 105.49447512610465d0, -122.59474478201288d0, &
                227.52417460894688d0, -126.2597384129594d0, 118.75117989962092d0, &
                -1.5051768093475526d0, 8.562414898102029d0, -1.693502453897044d0 /
  
  DATA left2 / -0.09165761253230811d0, -1.0100877689661594d0, 0.7905437610016559d0, &
                0.08529550258124016d0, 0.46021875472047963d0, -0.3980814806818628d0, &
                -0.13887859413506645d0, -1.2985935331860234d0, 0.9885016763968162d0, &
                0.11079913844671392d0, 0.6123501259132299d0, -0.5028960917095654d0, &
                0.22234507917902402d0, 2.291507964580495d0, -1.756313542111056d0, &
                -0.1918368990456516d0, -1.0612123498169421d0, 0.8865352374221388d0, &
                -0.09934055662710367d0, 0.826682845998962d0, -0.5077049296467399d0, &
                -0.08334894751470627d0, 1.002357219687475d0, -0.6237860934520787d0, &
                0.18796116873132362d0, -1.831089556300899d0, 1.1312699585795796d0 /
  DATA right2 / 1.0111657040642084d0, 4.064326038687206d0, 0.16846258022713467d0, &
                -3.5506429566055306d0, -7.990788334751925d0, -2.182518930294372d0, &
                6.246803206576854d0, 12.98741573261871d0, 10.367308772292617d0, &
                5.636778874087016d0, 10.690116333976434d0, 30.739773671316126d0, &
                -0.7190194276269423d0, 0.9545234353855702d0, -14.129097658240307d0, &
                2.102500838214577d0, -0.9431144829469508d0, 0.05131256788772643d0, &
                3.314841881874237d0, -1.7817457593618435d0, 1.3493106467838916d0, &
                5.228419733993317d0, -5.588526786097672d0, 3.09535168989133d0, &
                7.031182163777919d0, -10.012834657452048d0, 4.2963979842778866d0, &
                -6.7570100154263395d0, 10.639863170117842d0, -4.431157054856769d0, &
                -12.496869829024636d0, 23.95309512752951d0, -11.191038511186278d0, &
                -0.25511793974662095d0, 3.105525998799246d0, -0.2700075247878443d0 /
  DATA left3 / -0.26704300240729906d0, -0.021244137631247734d0, 0.005698796489891547d0, &
                0.11283604277220974d0, 0.019045454633044828d0, -0.0054277807029545185d0, &
                -0.5469201480659264d0, 0.1390065934386878d0, -0.01601625505901977d0, &
                0.2708598173868438d0, -0.07878943179251854d0, 0.009344615815916932d0, &
                0.8111313207199795d0, -0.12157599964456617d0, 0.013189802361680087d0, &
                -0.3834160670049347d0, 0.06336570626257887d0, -0.005829363923190015d0, &
                0.2125698651055652d0, 0.007932536482860863d0, -0.00124853550536081d0, &
                0.3193597622536932d0, -0.02167195555951595d0, -0.0015187500633450784d0, &
                -0.5247600432423136d0, 0.009563140232016603d0, 0.0029171635166231604d0 /
  DATA right3 / -0.3150344671029144d0, 7.363395001078842d0, 0.18630501915445655d0, &
                -0.9576430005524192d0, -2.8271106778713824d0, -0.8599630632534063d0, &
                -2.2992847874530837d0, -3.534208989980021d0, -2.319658720592565d0, &
                2.115642134468694d0, 6.272665143976334d0, 5.974450461799069d0, &
                0.5888717390998074d0, -1.7755382467572316d0, -1.0209269767285236d0, &
                1.4707685845122445d0, -0.24926081938255257d0, 0.0306479062551625d0, &
                0.347339469478298d0, -0.18901400041978014d0, 0.044021750409341934d0, &
                2.2022033947039525d0, -1.6328495350124697d0, 0.12767043506549883d0, &
                -3.465557297038497d0, 2.8964610624546245d0, 0.531207342268555d0, &
                -2.7075622949220635d0, 2.1708189359224606d0, 0.9901363088912304d0, &
                -7.6563481562115285d0, 7.7215240277806485d0, 5.1441415569288385d0, &
                0.08361335594468824d0, 0.5330486534456583d0, 0.08731307883881419d0 /

  DATA left4 / -0.7255764908622497d0, 0.3093792864396717d0, -0.04972994251238999d0, &
                0.43196107390671407d0, -0.21694226100958927d0, 0.03587075561538992d0, &
                -0.8331809868322648d0, 0.33645009481627325d0, -0.046566693017091876d0, &
                0.46642805756248357d0, -0.2174406467324864d0, 0.03192758597637695d0, &
                1.5214282268545376d0, -0.6182276335453512d0, 0.09193920949179708d0, &
                -0.8769564937958089d0, 0.4187362571018319d0, -0.06527303630214303d0, &
                0.2591505164264935d0, -0.018219696625697477d0, 0.0014599894833166724d0, &
                0.37702649496173785d0, -0.06106371579984695d0, 0.0048997611081584d0, &
                -0.6284002621066553d0, 0.073893129187332d0, -0.00579591281241008d0 /
  DATA right4 / 3.8526675952729166d0, -0.5569276374977795d0, 0.04528019859397363d0, &
                17.166502327516778d0, -0.45002686665649694d0, -0.18820682694326124d0, &
                -24.462015831364145d0, -6.159224437087954d0, 1.8399672551799358d0, &
                -6.261590646081136d0, -11.807307405220511d0, 2.748734636468226d0, &
                -3.7126314337964885d0, 14.060405013130548d0, -2.6174447194118313d0, &
                -1.1921369427480966d0, 1.3239339182810987d0, -0.05785069917390398d0, &
                0.2647118302555023d0, 0.20610301216238663d0, 0.2333740612693166d0, &
                0.3617041524382783d0, -0.285361076924459d0, -0.23845121580912843d0, &
                1.5877270765978815d0, -0.5343997363603614d0, -0.341836713115954d0, &
                -6.038348097520621d0, 1.0453428353642356d0, 0.6260596337936863d0, &
                -7.133728728079829d0, 0.11396959493126725d0, 0.04687586216904349d0, &
                0.289235549542202d0, -0.06477313647733891d0, 0.010361014288148208d0 /
  
  !------------------------------------------------------------
  ! Preprocessing
  !------------------------------------------------------------
  rkf = fa/rs
  ef = (rkf**2.d0)/2.d0
  k = xk / rkf
  t = temp / ef

  !------------------------------------------------------------
  ! Check for interpolation or extrapolation
  !------------------------------------------------------------
  IF (t.GT.2.d0) THEN
    PRINT*, "ERROR: Local electronic temperature is higher interpolation grid (T >= 2 TF)."
    PRINT*, "T = ", t, temp
    PRINT*, "rs = ", rs
    ! CALL par_stop
  ENDIF

  IF (rs.GT.20.d0) THEN
    PRINT*, "ERROR: rs > 20 is outside of fit range"
    CALL par_stop
  ENDIF

  IF (rs.LT.1.d-2) THEN
    PRINT*, "ERROR: rs < 0.01 is outside of fit range"
    CALL par_stop
  ENDIF

  ! Set to fermi level if below fermi level
  IF (k.LT.1.00001d0) THEN
      k = 1.00001d0
  ENDIF

  ! Determine which region of rs to use
  IF (rs.LT.0.2) THEN
      p = left1
      qq = right1
      mrs = 1
  ELSEIF (rs.LT.1.0) THEN
      p = left2
      qq = right2
      mrs = 2
  ELSEIF (rs.LT.5.0) THEN
      p = left3
      qq = right3
      mrs = 3
  ELSE
      p = left4
      qq = right4
      mrs = 4
  ENDIF
  
  !--------------------
  ! Imaginary part
  !--------------------
  CALL im_cusp_v2(rs, t, k_boundary)
  CALL im_kf_v2(rs, t, eim_kf)

  ! Left hand side
  rsleft(1) = p(1) * rs  + p(2)*rs**(3.d0/2.d0)  +  p(3)*rs**2.d0
  rsleft(2) = p(4) * rs  + p(5)*rs**(3.d0/2.d0)  +  p(6)*rs**2.d0
  rsleft(3) = p(7) * rs  + p(8)*rs**(3.d0/2.d0)  +  p(9)*rs**2.d0
  rsleft(4) = p(10) * rs + p(11)*rs**(3.d0/2.d0) +  p(12)*rs**2.d0
  rsleft(5) = p(13) * rs + p(14)*rs**(3.d0/2.d0) +  p(15)*rs**2.d0
  rsleft(6) = p(16) * rs + p(17)*rs**(3.d0/2.d0) +  p(18)*rs**2.d0
  rsleft(7) = p(19) * rs + p(20)*rs**(3.d0/2.d0) +  p(21)*rs**2.d0
  rsleft(8) = p(22) * rs + p(23)*rs**(3.d0/2.d0) +  p(24)*rs**2.d0
  rsleft(9) = p(25) * rs + p(26)*rs**(3.d0/2.d0) +  p(27)*rs**2.d0

  vleft = rsleft(1)*k*t &
        + rsleft(2)*k*(t**1.5d0) &
        + rsleft(3)*(k**2.d0)*t &
        + rsleft(4)*(k**2.d0)*(t**1.5d0) &
        + rsleft(5)*(k**1.5d0)*t &
        + rsleft(6)*(k**1.5d0)*(t**1.5d0) &
        + rsleft(7)*k & 
        + rsleft(8)*(k**2.d0) &
        + rsleft(9)*(k**1.5d0) &
        + eim_kf
  
  IF (vleft.LT.0.d0) THEN
    vleft = 0.d0
  ENDIF

  ! Right hand side
  rsright(1) = qq(1) * rs  + qq(2)*rs**(3.d0/2.d0)  +  qq(3)*rs**2.d0
  rsright(2) = qq(4) * rs  + qq(5)*rs**(3.d0/2.d0)  +  qq(6)*rs**2.d0
  rsright(3) = qq(7) * rs  + qq(8)*rs**(3.d0/2.d0)  +  qq(9)*rs**2.d0
  rsright(4) = qq(10) * rs  + qq(11)*rs**(3.d0/2.d0)  +  qq(12)*rs**2.d0
  rsright(5) = qq(13) * rs  + qq(14)*rs**(3.d0/2.d0)  +  qq(15)*rs**2.d0
  rsright(6) = qq(16) * rs  + qq(17)*rs**(3.d0/2.d0)  +  qq(18)*rs**2.d0

  tright(1) = qq(19) + qq(20)*t +  qq(21)*t**2.d0
  tright(2) = qq(22) + qq(23)*t +  qq(24)*t**2.d0
  tright(3) = qq(25) + qq(26)*t +  qq(27)*t**2.d0
  tright(4) = qq(28) + qq(29)*t +  qq(30)*t**2.d0
  tright(5) = qq(31) + qq(32)*t +  qq(33)*t**2.d0
  tright(6) = qq(34) + qq(35)*t +  qq(36)*t**2.d0

  vright = rsright(1)*tright(1)/k         &
         + rsright(2)*tright(2)/(k**2.d0) &
         + rsright(3)*tright(3)/(k**3.d0) &
         + rsright(4)*tright(4)/(k**4.d0) &
         + rsright(5)*tright(5)/(k**5.d0) &
         + rsright(6)*tright(6)/SQRT(k)

  IF (vright.LT.0.d0) THEN
    vright = 0.d0
  ENDIF
  
  ! Interpolate between regions
  weight = 1.d0/(1.d0 + EXP(15.d0*(k - 1.1d0*k_boundary)))
  eim = weight*vleft +  (1.d0-weight)*vright*scaling(mrs)

  ! Scale back
  eim = -eim * ef
  RETURN
END SUBROUTINE imgw_v2

SUBROUTINE im_kf_v2(rs, t, kf)
  ! Imaginary part of quasiparticle self-energy at fermi level
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, t
  REAL(8), INTENT(OUT) :: kf
  REAL(8), DIMENSION(12) :: factors1, factors2, factors3, factors4, factors
  REAL(8) :: A, B, C, D
  INTEGER :: mrs
  DATA factors1 / 0.006126619079058038d0, -0.022846382754034916d0, 0.015045114528861647d0, &
                  -0.14013765402506528d0, 1.732411629425611d0, -1.527915604967462d0, &
                  0.2041869214818972d0, -2.6592424440301077d0, 3.0210152215271107d0, &
                  -0.159621537197849d0, 2.269255518220703d0, -2.8208884235019287d0 /
  DATA factors2 / -0.00383652380506507d0, 0.002372632021212689d0, -0.0006936859623145972d0, &
                  0.477670622519175d0, -0.2516296967247694d0, 0.04232619703799145d0, &
                  -0.6070288526414329d0, 0.8402894704206122d0, -0.3056394124643722d0, &
                  0.25197834782489975d0, -0.43335938835885957d0, 0.17798795242083698d0 /
  DATA factors3 / -0.02526320970813707d0, 0.35287667298530234d0, -0.340763616688629d0, &
                  0.0035392012435348998d0, -0.05837406966292795d0, 0.417344190284107d0, &
                  -0.00024626463664617225d0, 0.00753983071122524d0, -0.1067418540332355d0, &
                  -1.4336855836569554e-06, -0.00010468083863930219d0, 0.0022898442682024144d0 /
  DATA factors4 / 0.23639874118322862d0, -0.3495821472113405d0, 0.12933931275338106d0, &
                  -0.22490690598335195d0, 0.8170914266911294d0, -0.36385883500314564d0, &
                  0.022055208809747342d0, -0.16116895879846668d0, 0.08724548039489805d0, &
                  0.0007796226273447165d0, 0.0011297583383124885d0, -0.001018029772211792d0/
 
  ! 00 -> 1
  ! 01 -> 2
  ! 10 -> 3
  ! 11 -> 4
  mrs = 1
  IF (rs.LE.0.2d0) THEN
    mrs = mrs + 0
  ELSE
    mrs = mrs + 2
  ENDIF

  IF (t.LE.0.5d0) THEN
    mrs = mrs + 0
  ELSE
    mrs = mrs + 1
  ENDIF

  ! Shift from 0-index to 1-index
  SELECT CASE (mrs)
    CASE (1)
      factors = factors1
    CASE (2)
      factors = factors2
    CASE (3)
      factors = factors3
    CASE (4)
      factors = factors4
  END SELECT

  A = factors(1)*t + factors(2)*t**1.5d0 + factors(3)*t**2.d0
  B = factors(4)*t + factors(5)*t**1.5d0 + factors(6)*t**2.d0
  C = factors(7)*t + factors(8)*t**1.5d0 + factors(9)*t**2.d0
  D = factors(10)*t + factors(11)*t**1.5d0 + factors(12)*t**2.d0
  kf = A*rs**0.5d0 + B*rs + C*rs**1.5d0 + D*rs**2.5d0
  IF (kf.LT.0.d0) THEN
    kf = 0.d0
  ENDIF
  RETURN
END SUBROUTINE im_kf_v2

SUBROUTINE im_cusp_v2(rs, t, k)
  ! Position of minimum for imaginary quasiparticle self-energy
  !
  ! Inputs:
  !   rs - radius
  !   t  - temperature in unit of fermi
  ! Output:
  !   k  - temperature in unit of fermi
  !
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, t
  REAL(8), INTENT(OUT) :: k
  REAL(8), PARAMETER :: alpha = 1.24469774d0
  REAL(8), PARAMETER :: beta = 0.03303176d0
  REAL(8), DIMENSION(6) :: factors 
  REAL(8) :: A, B
  DATA factors / 0.15104746d0, 0.23333948d0, -0.01594679d0,  1.36174536d0, -0.05237112d0, -0.02221209d0 /

  A = factors(1) + factors(2)*t + factors(3)*t**2.d0
  B = factors(4) + factors(5)*t + factors(6)*t**2.d0
  k = (1.d0 + TANH((rs - 0.5d0)/alpha))*(beta*rs + A) + B

  RETURN
END SUBROUTINE im_cusp_v2
  