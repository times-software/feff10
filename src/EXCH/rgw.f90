!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
! Information about last revision of $RCSfile: rhl.f90,v $:
! $Revision: 1.4 $
! $Author: hebhop $
! $Date: 2010/02/23 23:52:06 $
!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
SUBROUTINE rgw(rs, xk, temp, erl)
  USE constants
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, xk, temp
  REAL(8), INTENT(OUT) :: erl

  INTEGER, PARAMETER ::  nlt = 5, nlrs = 4, nrt = 2, nrrs = 3
  REAL(8), DIMENSION(:) :: tleft(5), rsleft(4), tright(3), rsright(3)
  REAL(8), DIMENSION(27) :: left1, left2, left3, left4
  REAL(8), DIMENSION(15) :: right1, right2, right3, right4
  REAL(8) :: vleft, vright, weight, k_boundary, eee, left0, t, k, wp, rkf, ef
  
  REAL(8), DIMENSION(27) :: p
  REAL(8), DIMENSION(15) :: qq
  ! DATA p / 2.5344908519150277648180d0,      -0.3404592250356968663461d0,       0.2090924044894818256690d0, &
  !         -6.2531413812700469279093d0,      -1.2882761371134692218732d0,      -0.1545959102722999634061d0, &
  !         6.3092788968560729045976d0,      -0.3712659829797280708341d0,       0.4561735015743797472254d0, &
  !         1.0517044701577911158807d0,       0.9980885389251320516379d0,      -0.1262961858879391718880d0, &
  !         -1.5864423552937068073732d0,      -0.0703517047897053715566d0,       0.0012095316268887058939d0, &
  !         0.6265240382967289800575d0,      -0.0345491408824314047421d0,       0.0475813589973176492842d0, &
  !         1.1214446081724578352379d0,       0.0000158118170277364426d0,       0.0378391859065193569833d0, &
  !         0.5760739892638068182507d0,      -0.0591688129460346545763d0,       0.0696403645308140417658d0, &
  !         -0.0209456339452350516483d0,       0.0320039948622821771029d0,      -0.0007924053800554207690d0/

  ! DATA qq / 78637966.0787817537784576416016d0, 311217296.7055425047874450683594d0, -12127688.5634898133575916290283d0, &
  !         -0.1313637765537457313680d0,      -0.2846930273653715537385d0,       0.0139082160012960597689d0, &
  !         -0.7582546438957535883674d0,       3.7042943840493092189092d0,      -0.2725344901748169568201d0, &
  !          3.0528050686602790086965d0,       0.7089354835299107593372d0,      -0.6289703483429308628061d0, &
  !          0.4129987887383732569901d0,       0.2055510771521086854641d0,      -0.1132810050944537821893d0 /


  DATA left1/ 1.2154134208095004d0, -4.508816240359177d0, 11.97698761986273d0, &
              1.029009842611702d0, -7.243415266109083d0, 23.33202585152756d0, &
              1.2369761501564556d0, -6.223807061499287d0, 18.14943199920946d0, &
              0.40358858199494435d0, -4.354830869637849d0, 15.501627868057078d0, &
              -6.525885979048827d0, 3.252201256859724d0, -0.6080473609125667d0, &
              -8.622666469061805d0, 4.821019804126895d0, -0.9930420373493627d0, &
              12.073120786108186d0, -6.4928164712145415d0, 1.2909333493367048d0, &
              3.917630502317266d0, -2.2250639617884422d0, 0.4664176928931159d0, &
              -0.0002913680954701001d0, 0.001102119504261212d0, -0.0003347159507350774d0 /

  DATA right1/ 62798400.694744214d0, 79885552.49571729d0, -61337388.52634566d0, &
               0.5346554263875789d0, -0.5651101777324324d0, 1.8738775250643693d0, &
               0.3610699572007695d0, -1.5637471619292d0, 4.107115105254552d0, &
               -0.5644568492314478d0, -0.44104734176745714d0, 0.07004901166054882d0, &
               -0.07218918308832134d0, 0.8775972530665443d0, 0.03470894995029971d0 /

  DATA left2/0.42478487081400573d0, -2.765565312702711d0, 1.413712045371367d0, &
              1.8008959412556513d0, -5.511781319389452d0, 2.875404181280661d0, &
              -1.1165589022045965d0, 4.155085805524251d0, -2.150770107359026d0, &
              1.2917078801078052d0, -3.614898998919843d0, 1.9022101205756106d0, &
              5.350869687205111d0, -0.5026845175588389d0, -0.15396574514270045d0, &
              9.373849864823613d0, -1.6438575214764517d0, 0.004280818867507963d0, &
              11.694218235303818d0, -1.6291144624856047d0, -0.16101555512766996d0, &
              -4.868323364472416d0, 0.9470904674414855d0, -0.04702950176365168d0, &
              -0.012640460224829784d0, 0.019161157710872564d0, -0.004262966329670912d0 /

  DATA right2/ 8506976.524928845d0, 49450609.38150841d0, -19148117.040330067d0, &
                2.125260762220303d0, 0.39526176892125203d0, -0.2637442881384847d0, &
                2.0976711275164974d0, -0.5177622167149698d0, 0.9646134330597216d0, &
                -0.3334561771389293d0, -0.20556723599763893d0, 0.07739791566506975d0, &
                0.22005329730563267d0, 0.3222403436910038d0, -0.09636278516858485d0 /
  
  DATA left3/ 2.5344908519150278d0, -0.34045922503569687d0, 0.20909240448948183d0, &
                -6.253141381270047d0, -1.2882761371134692d0, -0.15459591027229996d0, &
                6.309278896856073d0, -0.37126598297972807d0, 0.45617350157437975d0, &
                1.0517044701577911d0, 0.998088538925132d0, -0.12629618588793917d0, &
                -1.5864423552937068d0, -0.07035170478970537d0, 0.001209531626888706d0, &
                0.626524038296729d0, -0.034549140882431405d0, 0.04758135899731765d0, &
                1.1214446081724578d0, 1.5811817027736443d-5, 0.03783918590651936d0, &
                0.5760739892638068d0, -0.059168812946034655d0, 0.06964036453081404d0, &
                -0.02094563394523505d0, 0.03200399486228218d0, -0.0007924053800554208d0 /

  DATA right3/ 78637966.07878175d0, 311217296.7055425d0, -12127688.563489813d0, &
                -0.13136377655374573d0, -0.28469302736537155d0, 0.01390821600129606d0, &
                -0.7582546438957536d0, 3.704294384049309d0, -0.27253449017481696d0, &
                3.052805068660279d0, 0.7089354835299108d0, -0.6289703483429309d0, &
                0.41299878873837326d0, 0.20555107715210869d0, -0.11328100509445378d0 /
  
  DATA left4/ 0.2993158634964539d0, 1.625125795930575d0, -0.2287001580618493d0, &
              1.9351156358534447d0, 1.486385504665352d0, -0.27231997267857966d0, &
              1.2396680043134514d0, 1.9448397131933621d0, -0.31003687759808185d0, &
              2.328977751230831d0, 0.8835261791434674d0, -0.19774034154529302d0, &
              -1.3242329783616744d0, 0.0950061930026322d0, 0.01668566331718798d0, &
              -1.3819322069998992d0, 0.29087403267083034d0, -0.007844189680559794d0, &
              1.828253099747466d0, -0.2607012137868943d0, -0.007553184872345978d0, &
              0.4075947748403373d0, -0.10769700661487398d0, 0.0055513391816981806d0, &
              -0.5402740829426358d0, 0.058999510608476025d0, 0.004566792900479818d0 /

  DATA right4/ 25343208.713695824d0, -28305801.47662847d0, -74437595.52635065d0, &
                0.7558224839914135d0, -1.0500056608761195d0, 0.1563053901402796d0, &
                -1.7177311660206924d0, 1.7866351771464843d0, -0.2807943980619071d0, &
                2.6934109989894948d0, -1.2072374495844942d0, 0.5334795894434334d0, &
                3.1140946102853815d0, -1.6792786833930664d0, 0.9473416778998698d0 /
  
  !------------------------------------------------------------
  ! Preprocessing
  !------------------------------------------------------------
  rkf = fa/rs
  ef = rkf**2.d0/2.d0
  wp = SQRT(3.d0/rs**3.d0)
  eee = -pi*wp/(4.d0*rkf*ef)
  k = xk / rkf
  t = temp / ef

  !------------------------------------------------------------
  ! Check for interpolation or extrapolation
  !------------------------------------------------------------
  IF (t.GT.2.d0) THEN
    PRINT*, "ERROR: Local electronic temperature is higher interpolation grid (T > 2 TF)."
    PRINT*, "T = ", t, temp
    PRINT*, "rs = ", rs
    CALL par_stop
  ENDIF

  IF (rs.GT.20.d0) THEN
    PRINT*, "ERROR: rs > 20 is outside of fit range"
    CALL par_stop
  ENDIF

  IF (rs.LT.1.d-2) THEN
    PRINT*, "ERROR: rs < 0.01 is outside of fit range"
    CALL par_stop
  ENDIF

  IF (k.GT.20.d0) THEN
    PRINT*, "ERROR: k is higher interpolation grid (k > 20kF)."
    PRINT*, "T = ", t, temp
    PRINT*, "rs = ", rs
    PRINT*, "k = ", k
    CALL par_stop
  ENDIF

  ! Set to fermi level if below fermi level
  IF (k.LT.1.00001d0) THEN
      k = 1.00001d0
  ENDIF

  ! Determine which region of rs to use
  IF (rs.LT.0.2) THEN
      p = left1
      qq = right1
  ELSEIF (rs.LT.1.0) THEN
      p = left2
      qq = right2
  ELSEIF (rs.LT.5.0) THEN
      p = left3
      qq = right3
  ELSE
      p = left4
      qq = right4
  ENDIF
  
  !--------------------
  ! Real part
  !--------------------
  CALL real_cusp(rs, t, k_boundary)

  ! Reference
  

  ! Left hand side
  rsleft(1) = p(1) * rs  + p(2)*rs**(3.d0/2.d0)  +  p(3)*rs**2.d0
  rsleft(2) = p(4) * rs  + p(5)*rs**(3.d0/2.d0)  +  p(6)*rs**2.d0
  rsleft(3) = p(7) * rs  + p(8)*rs**(3.d0/2.d0)  +  p(9)*rs**2.d0
  rsleft(4) = p(10) * rs + p(11)*rs**(3.d0/2.d0) +  p(12)*rs**2.d0
  tleft(1) = p(13) + p(14)*t +  p(15)*t**2.d0
  tleft(2) = p(16) + p(17)*t +  p(18)*t**2.d0
  tleft(3) = p(19) + p(20)*t +  p(21)*t**2.d0
  tleft(4) = p(22) + p(23)*t +  p(24)*t**2.d0
  tleft(5) = p(25) + p(26)*t +  p(27)*t**2.d0
  vleft = tleft(1)*rsleft(1)*k &
          + tleft(2)*rsleft(2)*k**(2.d0) &
          + tleft(3)*rsleft(3)*k**(1.5d0) &
          + tleft(4)*rsleft(4)*k**(2.5d0) &
          + tleft(5)

  left0 = tleft(1)*rsleft(1)*k_boundary &
          + tleft(2)*rsleft(2)*k_boundary**(2.d0) &
          + tleft(3)*rsleft(3)*k_boundary**(1.5d0) &
          + tleft(4)*rsleft(4)*k_boundary**(2.5d0) &
          + tleft(5)

  ! Right hand side
  rsright(1) = qq(1) * rs  + qq(2)*rs**(3.d0/2.d0)  +  qq(3)*rs**2.d0
  rsright(2) = qq(4) * rs  + qq(5)*rs**(3.d0/2.d0)  +  qq(6)*rs**2.d0
  rsright(3) = qq(7) * rs  + qq(8)*rs**(3.d0/2.d0)  +  qq(9)*rs**2.d0
  tright(2) = qq(10) + qq(11)*t +  qq(12)*t**2.d0
  tright(3) = qq(13) + qq(14)*t +  qq(15)*t**2.d0
  tright(1) = k_boundary*(left0 - tright(2)*rsright(2)/k_boundary**2 - tright(3)*rsright(3)/k_boundary**(3))/(rsright(1)*eee)
  vright = eee*tright(1)*rsright(1)/k + tright(2)*rsright(2)/k**2 + tright(3)*rsright(3)/k**(3)


  ! Interpolation
  weight = 1.d0/(1.d0 + EXP(15.d0*(k - k_boundary)))
  erl = weight*vleft + (1.d0-weight)*vright

  ! Scale back
  erl = erl * ef
  RETURN
END

SUBROUTINE real_cusp(rs, t, k)
  ! Position of minimum for real sigma
  !
  ! Inputs:
  !   rs - radius
  !   t  - temperature in unit of fermi
  ! Output:
  !   k  - temperature in unit of fermi
  !
  IMPLICIT NONE
  REAL(8), INTENT(IN) :: rs, t
  REAL(8), INTENT(OUT) :: k
  REAL(8), PARAMETER :: alpha = 6.4226400052591925d0
  REAL(8), PARAMETER :: beta = 0.06579409601454807d0
  REAL(8), DIMENSION(9) :: factors
  REAL(8) :: A, B, C
  DATA factors / 11.789533109217384d0, 25.56619569021551d0, -8.718509700959657d0, &
                 0.07937961365220357d0, 0.1642978703589978d0, -0.0019130964169998144d0, &
                 1.4999860733980672d0, -3.021030697663565d-6, -0.0005684185963082104d0 /
  
  A = factors(1) + factors(2)*t + factors(3)*t**2.d0
  B = factors(4) + factors(5)*t + factors(6)*t**2.d0
  C = factors(7) + factors(8)*t + factors(9)*t**2.d0

  IF (rs.LE.1.0d0) THEN
    k = 1.5d0
  ELSE
    k = (1.d0 + TANH(alpha*rs-A)) * (beta*LOG(rs)**2.d0 + B) + C
  ENDIF

  RETURN
END SUBROUTINE
  